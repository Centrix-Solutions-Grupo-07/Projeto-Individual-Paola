<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../assets/icon/favicon.ico">
    <title>Dashboard | Home</title>
    <link rel="stylesheet" href="../css/barra_lateral.css">
    <link rel="stylesheet" href="../css/dashboard_main.css">
    <script src="../js/notificacao.js"></script>
    <script src="../js/andar.js"></script>
    <script src="../js/nivelAcesso.js"></script>
</head>

<body onload="buscarComputadores(), buscarAndares(), listarLateral()">
    <div id="cadastroAndar_div" class="div_cadastrarAndar">
        <div class="conteudo_cadastrarAndar">
            <div class="div_tituloCadastrarAndar">
                <span class="close" onclick="aparecerTelaCadastroAndar()">&times;</span>
                <span class="titulo_novoAndar">Cadastre um novo andar</span>
            </div>
            <div class="div_crudAndar">
                <div>
                    <div class="div_cadastrarAndarInput">
                        <span>Andar</span>
                        <input class="input_cadastrarAndar" type="number" id="numeroAndar" name="numAndar" />
                    </div>
                </div>
                <div class="div_enviandoImg">
                    <span>Foto da planta do andar</span>
                    <input class="input_enviandoImg" type="file" id="foto" name="foto"/>
                </div>
            </div>
            <div class="div_btnCadastrarAndar">
                <button class="btn_cadastrarAndar cursor" onclick="cadastrarAndar()">Cadastrar</button>
            </div>
        </div>
    </div>
    <div class="container_principal">
        <div class="barra_lateral" id="lateral_barra"></div>
        <div class="area_dash">
            <div class="dash_superior">
                <div class="bem_vindo">
                    <span class="text_bemVindo1">Bem-Vindo a Home de Monitoramento</span>
                    <span class="text_bemVindo2">Veja as principais atualizações dos últimos momentos aqui</span>
                </div>
                <div class="dash_perfil">
                    <div class="perfil_nome">
                        <span class="text_perfilNome" id="nomeFuncionario">Nishikigi Chisato</span>
                        <span class="text_perfilEmail" id="emailFuncionario">nishikigi.chisato@gmail.com</span>
                    </div>
                    <div class="perfil_img">
                        <div class="perfil_imagem"></div>
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="12" viewBox="0 0 18 12"
                                fill="none">
                                <path d="M1 1.75L9 10.25L17 1.75" stroke="white" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class="div_central">
                <div class="div_mapa" id="mapa_div"></div>
                <div class="div_funcionalidades">
                    <div class="div_legenda">
                        <span class="text_legenda">Legenda</span>
                        <div>
                            <div class="div_bola">
                                <div class="bola verde"></div>
                                <span>ativo e sem problemas</span>
                            </div>
                            <div class="div_bola">
                                <div class="bola laranja"></div>
                                <span>ativo e com nível em atenção nos alertas</span>
                            </div>
                            <div class="div_bola">
                                <div class="bola vermelha"></div>
                                <span>ativo e com nível em perigo nos alertas</span>
                            </div>
                            <div class="div_bola">
                                <div class="bola roxa"></div>
                                <span>desativado</span>
                            </div>
                            <div class="div_bola">
                                <div class="bola azul"></div>
                                <span>computador selecionado</span>
                            </div>
                        </div>
                    </div>
                    <div class="div_funcoes">
                        <div class="div_func">
                            <span class="text_legenda">Cadastre um novo andar</span>
                            <button class="func_btn cursor" onclick="aparecerTelaCadastroAndar()">
                                Novo Andar
                                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="16" viewBox="0 0 28 16"
                                    fill="none">
                                    <path
                                        d="M27.7071 8.70711C28.0976 8.31658 28.0976 7.68342 27.7071 7.29289L21.3431 0.928932C20.9526 0.538408 20.3195 0.538408 19.9289 0.928932C19.5384 1.31946 19.5384 1.95262 19.9289 2.34315L25.5858 8L19.9289 13.6569C19.5384 14.0474 19.5384 14.6805 19.9289 15.0711C20.3195 15.4616 20.9526 15.4616 21.3431 15.0711L27.7071 8.70711ZM0 9H13V7H0L0 9ZM13 9H27V7H13V9Z"
                                        fill="white" fill-opacity="0.69" />
                                </svg>
                            </button>
                        </div>
                        <div class="div_func">
                            <span class="text_legenda">
                                Veja o monitoramento individual
                            </span>
                            <button class="func_btn cursor tdComputador" onclick="irMonitoramento(sessionStorage.idComputador)">
                                Monitoramento
                                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="16" viewBox="0 0 28 16"
                                    fill="none">
                                    <path
                                        d="M27.7071 8.70711C28.0976 8.31658 28.0976 7.68342 27.7071 7.29289L21.3431 0.928932C20.9526 0.538408 20.3195 0.538408 19.9289 0.928932C19.5384 1.31946 19.5384 1.95262 19.9289 2.34315L25.5858 8L19.9289 13.6569C19.5384 14.0474 19.5384 14.6805 19.9289 15.0711C20.3195 15.4616 20.9526 15.4616 21.3431 15.0711L27.7071 8.70711ZM0 9H13V7H0L0 9ZM13 9H27V7H13V9Z"
                                        fill="white" fill-opacity="0.69" />
                                </svg>
                            </button>
                        </div>
                        <div class="div_func">
                            <span class="text_legenda">Salvar posição dos computadores</span>
                            <button class="func_btn cursor" onclick="salvarPosicaoComputadores()">
                                Salvar
                                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="16" viewBox="0 0 28 16"
                                    fill="none">
                                    <path
                                        d="M27.7071 8.70711C28.0976 8.31658 28.0976 7.68342 27.7071 7.29289L21.3431 0.928932C20.9526 0.538408 20.3195 0.538408 19.9289 0.928932C19.5384 1.31946 19.5384 1.95262 19.9289 2.34315L25.5858 8L19.9289 13.6569C19.5384 14.0474 19.5384 14.6805 19.9289 15.0711C20.3195 15.4616 20.9526 15.4616 21.3431 15.0711L27.7071 8.70711ZM0 9H13V7H0L0 9ZM13 9H27V7H13V9Z"
                                        fill="white" fill-opacity="0.69" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="div_inferior">
                <div class="inferior_computadores">
                    <span class="text_computadores">Computadores</span>
                    <div class="div_computadores">
                        <table class="computadores_table" id="lista_computador">
                            <tr>
                                <td>Selecione um andar para começar!</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="inferior_notificacores">
                    <div class="div_notificacoes">
                        <span class="text_legenda">Andar</span>
                        <div class="div_andares">
                            <div>
                                <label for="andares">Selecione o Andar que deseja monitorar</label>
                                <select name="andares" class="select_andares" id="andares"></select>
                            </div>
                            <div>
                                <button class="btn_andares cursor" onclick="buscarComputadores()">
                                    Selecionar Andar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
<script>
    nomeFuncionario.innerHTML = sessionStorage.nome;
    emailFuncionario.innerHTML = sessionStorage.email;
    window.addEventListener('keydown', function (e) {
        if ([37, 38, 39, 40].indexOf(e.keyCode) > -1) {
            e.preventDefault();
        }
    });
    setTimeout(() => {
        const atual = document.getElementById('option1');
        atual.style.backgroundColor = "blueviolet";
    }, 50);
    sessionStorage.idComputador = 0;
    var vetorIdComputador = [];
    var vetorPosicaoComputador = [];
    var vetorIdDispositivo = [];
    var vetorImagensAndar = [];
    var vetorPosicaoImagensAndar = [];

    var maxMapaHorizontal = 0;
    var maxMapaVertical = 0;

    async function buscarComputadores() {
        vetorIdComputador = [];
        vetorPosicaoComputador = [];
        vetorIdDispositivo = [];

        var idEmpresaVar = sessionStorage.Empresa;
        var idAndarVar = andares.value.split('-')[1];
        if (idAndarVar == 0) idAndarVar = null;
        try {
            var resposta = await fetch("/dashboard/buscarComputadores", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    idEmpresaServer: idEmpresaVar,
                    idAndarServer: idAndarVar
                })
            });
            if (resposta.ok) {
                var respostaJson = await resposta.json();
                console.log('JSON: ', respostaJson);
                var tableLista = document.getElementById("lista_computador");
                var div_mapa = document.getElementById("mapa_div");
                div_mapa.innerHTML = "";
                tableLista.innerHTML = "";
                var thead = document.createElement("thead");
                var tr = document.createElement("tr");
                var idThead = document.createElement("th");
                var SOThead = document.createElement("th");
                var FuncionarioThead = document.createElement("th");
                var statusThead = document.createElement("th");
                idThead.innerHTML = "Id";
                SOThead.innerHTML = "SO";
                FuncionarioThead.innerHTML = "Funcionário";
                statusThead.innerHTML = "Status";
                tr.appendChild(idThead);
                tr.appendChild(SOThead);
                tr.appendChild(FuncionarioThead);
                tr.appendChild(statusThead);
                thead.appendChild(tr);
                tableLista.appendChild(thead);

                var andar = vetorPosicaoImagensAndar.indexOf(Number(idAndarVar));
                if (andar >= 0) {
                    carregarImagem(andar);
                } else {
                    div_mapa.style.backgroundImage = "";
                }
                for (let i = 0; i < respostaJson.length; i++) {
                    var tr = document.createElement("tr");
                    var tdId = document.createElement("td");
                    var tdNome = document.createElement("td");
                    var tdData = document.createElement("td");
                    var tdStatus = document.createElement("td");

                    tdId.innerHTML = respostaJson[i].Id_do_dispositivo;
                    tdNome.innerHTML = respostaJson[i].Sistema_Operacional;
                    var nome = respostaJson[i].Email;
                    if (nome == undefined) {
                        nome = "Nenhum usuário";
                    }
                    tdData.innerHTML = nome;
                    tdStatus.innerHTML = "ATIVO";
                    if (respostaJson[i].dataHoraEntrada == null || respostaJson[i].dataHoraEntrada != null && respostaJson[i].dataHoraSaida != null) tdStatus.innerHTML = "INATIVO";

                    tr.className = "computadores_individual cursor";
                    tdId.className = "tdComputador";
                    tdNome.className = "tdComputador";
                    tdData.className = "tdComputador";
                    tdStatus.className = "tdComputador";
                    tr.appendChild(tdId);
                    tr.appendChild(tdNome);
                    tr.appendChild(tdData);
                    tr.appendChild(tdStatus);

                    var bola = document.createElement("div");
                    bola.className = "bola_posicao";
                    if(tdStatus.innerHTML == "ATIVO"){
                        bola.classList.add("verde");
                    } else {
                        bola.classList.add("roxa");
                    }
                    div_mapa.appendChild(bola);
                    bola.id = respostaJson[i].idMaquina;

                    if (vetorIdComputador.indexOf(Number(bola.id)) == -1) {
                        vetorIdComputador.push(Number(bola.id));
                        vetorPosicaoComputador.push([respostaJson[i].posicaoX, respostaJson[i].posicaoY]);
                        sessionStorage.vetorIdComputador = vetorIdComputador;
                        vetorIdDispositivo.push(respostaJson[i].Id_do_dispositivo);
                    }
                    bola.addEventListener('click', function () {
                        var computadorId = sessionStorage.idComputador;
                        var idBola = this.id;
                        var computadorAtual = document.getElementById(idBola);
                        var descobreIdComputador = vetorIdComputador.indexOf(Number(idBola));
                        alert(`Você clicou no computador de id ${vetorIdDispositivo[descobreIdComputador]}`);
                        if (computadorId == 0) {
                            computadorAtual.classList.add("azul");
                            sessionStorage.setItem('idComputador', idBola);
                        } else {
                            var computadorAntigo = document.getElementById(computadorId);
                            computadorAntigo.classList.remove("azul");
                            computadorAtual.classList.add("azul");
                            sessionStorage.setItem('idComputador', idBola);
                        }
                    });
                    tr.id = `tr-${respostaJson[i].idMaquina}`;

                    tableLista.appendChild(tr);
                    var selectAndares = document.getElementById("andares");
                    selectAndares = selectAndares.value;
                    sessionStorage.setItem('idAndar', selectAndares);
                }
                setTimeout(() => {
                    for (let i = 0; i < respostaJson.length; i++) {
                    var tr = document.getElementById(`tr-${respostaJson[i].idMaquina}`);
                    tr.addEventListener('click', function () {
                        var computadorId = sessionStorage.idComputador;
                        var idBola = this.id;
                        idBola = idBola.split('-')[1];
                        var computadorAtual = document.getElementById(idBola);
                        var descobreIdComputador = vetorIdComputador.indexOf(Number(idBola));
                        alert(`Você clicou no computador de id ${vetorIdDispositivo[descobreIdComputador]}`);
                        console.log(computadorId)
                        if (computadorId == 0) {
                            computadorAtual.classList.add("azul");
                            sessionStorage.setItem('idComputador', idBola);
                            // console.log(computadorAtual);
                            // console.log(sessionStorage.idComputador);
                        } else {
                            var computadorAntigo = document.getElementById(computadorId);
                            computadorAntigo.classList.remove("azul");
                            computadorAtual.classList.add("azul");
                            sessionStorage.setItem('idComputador', idBola);
                        }
                    });
                }
                }, 100);
                atualizarPosicao();
            }
        } catch (erro) {
            console.log("Erro: ", erro);
        }
    }
    function atualizarPosicao() {
        for (let i = 0; i < vetorIdComputador.length; i++) {
            var bola = document.getElementById(`${vetorIdComputador[i]}`);
            bola.style.left = vetorPosicaoComputador[i][0] + 'px';
            bola.style.top = vetorPosicaoComputador[i][1] + 'px';
        }
    }
    document.addEventListener('click', function () {
        if (!event.target.classList.contains('bola_posicao') && !event.target.classList.contains('computadores_individual') && !event.target.classList.contains('tdComputador')) {
            var computadorId = sessionStorage.idComputador;
            var computadorAtual = document.getElementById(computadorId);
            computadorAtual.classList.remove("azul");
            sessionStorage.setItem('idComputador', 0);
        }
    });
    function aparecerTelaCadastroAndar() {
        var modal = document.getElementById('cadastroAndar_div');
        if (modal.style.display === 'none' || modal.style.display === '') modal.style.display = 'block'; else modal.style.display = 'none';
    }
    window.onclick = function (event) {
        var modal = document.getElementById('cadastroAndar_div');
        if (event.target == modal) modal.style.display = 'none';
    }
    function cadastrarAndar() {
        var idEmpresaVar = sessionStorage.Empresa;
        const formData = new FormData();
        formData.append('foto', foto.files[0]);
        formData.append('numAndar', numeroAndar.value);
        formData.append('idEmpresa', idEmpresaVar);
        fetch("/dashboard/cadastrarAndar", {
            method: "POST",
            body: formData
        })
            .then(res => {
                buscarAndares();
                alert("Andar cadastrado com sucesso!");
            })
            .catch(err => {
                console.log(err);
            })
    }
    document.onkeydown = function (e) {
        var id = sessionStorage.idComputador;
        if (id != 0 && e.keyCode == 37 || e.keyCode == 38 || e.keyCode == 39 || e.keyCode == 40) {
            const bola = document.getElementById(`${id}`);
            var posicaoComputador = vetorIdComputador.indexOf(Number(bola.id));
            var horizontal = vetorPosicaoComputador[posicaoComputador][0];
            var vertical = vetorPosicaoComputador[posicaoComputador][1];
            switch (e.keyCode) {
                case 37:
                    if (horizontal > 0) {
                        horizontal -= 1;
                        vetorPosicaoComputador[posicaoComputador][0] = horizontal;
                        bola.style.left = horizontal + 'px';
                    }
                    break;
                case 38:
                    if (vertical > 0) {
                        vertical -= 1;
                        vetorPosicaoComputador[posicaoComputador][1] = vertical;
                        bola.style.top = vertical + 'px';
                    }
                    break;
                case 39:
                    if (horizontal < maxMapaHorizontal) {
                        horizontal += 1;
                        vetorPosicaoComputador[posicaoComputador][0] = horizontal;
                        bola.style.left = horizontal + 'px';
                    }
                    break;
                case 40:
                    if (vertical < maxMapaVertical) {
                        vertical += 1;
                        vetorPosicaoComputador[posicaoComputador][1] = vertical;
                        bola.style.top = vertical + 'px';
                    }
                    break;
            }
        }
    };
    async function salvarPosicaoComputadores() {
        for (let i = 0; i < vetorIdComputador.length; i++) {
            var idComputador = vetorIdComputador[i];
            var x = vetorPosicaoComputador[i][0];
            var y = vetorPosicaoComputador[i][1];
            try {
                var resposta = await fetch("/dashboard/salvarPosicaoComputadores", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        idComputadorServer: idComputador,
                        xServer: x,
                        yServer: y
                    })
                });
                if (resposta.ok) {
                    var respostaJson = await resposta.json();
                    console.log('JSON: ', respostaJson);
                }
            } catch (erro) {
                console.log("Erro: ", erro);
            }
        }
        if (resposta.ok) {
            alert("Posições salvas!");
        }
    }
    async function carregarImagem(idImagem) {
        var div_mapa = document.getElementById("mapa_div");

        var larguraDaDiv = div_mapa.offsetWidth;
        var alturaDaDiv = div_mapa.offsetHeight;

        maxMapaHorizontal = larguraDaDiv;
        maxMapaVertical = alturaDaDiv;

        var imagem = vetorImagensAndar[idImagem];
        var imageURL = `../assets/andares/${imagem}`;

        var img = new Image();
        img.src = imageURL;

        await new Promise((resolve) => {
            img.onload = resolve;
        });

        var larguraImagem = img.naturalWidth;
        var alturaImagem = img.naturalHeight;

        div_mapa.style.backgroundImage = `url(${imageURL})`;

        if (larguraImagem > larguraDaDiv || alturaImagem > alturaDaDiv) {
            div_mapa.style.backgroundSize = "contain";
        } else {
            div_mapa.style.backgroundSize = "cover";
        }
    }
</script>